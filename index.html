<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uniswap V3 LP Strategy Backtester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .input-field { background: #1e293b; border: 1px solid #334155; padding: 0.5rem; border-radius: 0.375rem; color: white; }
        .btn { background: #3b82f6; padding: 0.75rem; border-radius: 0.375rem; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:hover { background: #2563eb; }
        .card { background: #1e293b; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #334155; }
        .stat-label { color: #94a3b8; font-size: 0.875rem; }
        .stat-value { font-size: 1.5rem; font-weight: bold; }
        .text-green { color: #4ade80; }
        .text-red { color: #f87171; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-7xl mx-auto">

    <div class="mb-8">
        <h1 class="text-3xl font-bold mb-2">LP Strategy Backtester</h1>
        <p class="text-slate-400">Simulate rebalancing strategies and compare Fees vs. Impermanent Loss vs. DCA.</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Configuration Panel -->
        <div class="card h-fit">
            <h2 class="text-xl font-bold mb-4 border-b border-slate-700 pb-2">Strategy Settings</h2>
            
            <div class="flex flex-col gap-4">
                <!-- Token Selector -->
                <div class="input-group">
                    <label class="text-sm">Select Token</label>
                    <select id="tokenSelect" class="input-field">
                        <option value="ETH">ETH (Ethereum)</option>
                        <option value="BTC">BTC (Bitcoin)</option>
                        <option value="AVAX">AVAX (Avalanche)</option>
                        <option value="BNB">BNB (Binance Coin)</option>
                        <option value="S">S (Sonic)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label class="text-sm">Initial Capital ($)</label>
                    <input type="number" id="initialCapital" value="10000" class="input-field">
                </div>

                <div class="input-group">
                    <label class="text-sm">LP Range (+/- %)</label>
                    <small class="text-slate-500">The width of your liquidity position.</small>
                    <input type="number" id="rangePct" value="20" class="input-field">
                </div>

                <div class="input-group">
                    <label class="text-sm">Rebalance Threshold (+/- %)</label>
                    <small class="text-slate-500">Trigger rebalance if price moves this much.</small>
                    <input type="number" id="rebalanceThreshold" value="15" class="input-field">
                </div>

                <div class="input-group">
                    <label class="text-sm">Estimated APR (%)</label>
                    <small class="text-slate-500">Fixed APR assumption for fees.</small>
                    <input type="number" id="fixedApr" value="70" class="input-field">
                </div>

                <div class="input-group">
                    <label class="text-sm">Candle Interval</label>
                    <select id="candleInterval" class="input-field">
                        <option value="5m">5 Minutes</option>
                        <option value="1h">1 Hour</option>
                        <option value="6h" selected>6 Hours</option>
                        <option value="1d">1 Day</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-2 mt-2">
                    <div class="input-group">
                        <label class="text-sm">Start Date</label>
                        <input type="date" id="startDate" class="input-field">
                    </div>
                    <div class="input-group">
                        <label class="text-sm">End Date</label>
                        <input type="date" id="endDate" class="input-field">
                    </div>
                </div>

                <button onclick="runBacktest()" id="runBtn" class="btn text-center mt-2">
                    Run Backtest
                </button>
                
                <button onclick="downloadReport()" id="dlBtn" class="btn bg-slate-700 hover:bg-slate-600 text-center mt-2 hidden">
                    Download Report ðŸ“¸
                </button>
                
                <p id="statusMsg" class="text-sm text-center text-yellow-400 min-h-[20px]"></p>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="col-span-1 md:col-span-2 flex flex-col gap-6">
            
            <!-- Summary Stats -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="card text-center px-2">
                    <div class="stat-label">Total Fees</div>
                    <div class="stat-value text-green-400 text-xl" id="resFees">$0.00</div>
                </div>
                <div class="card text-center px-2">
                    <div class="stat-label">LP Portfolio</div>
                    <div class="stat-value text-xl" id="resPortfolio">$0.00</div>
                    <div class="text-[10px] text-slate-500">Start: $<span id="resInitial">10000</span></div>
                </div>
                <div class="card text-center px-2">
                    <div class="stat-label">HODL (50/50)</div>
                    <div class="stat-value text-blue-400 text-xl" id="resHodl">$0.00</div>
                </div>
                <div class="card text-center px-2">
                    <div class="stat-label" id="resHodl100Label">HODL (100% ETH)</div>
                    <div class="stat-value text-yellow-400 text-xl" id="resHodl100">$0.00</div>
                </div>
                
                <!-- DCA Card (Interactive) -->
                <div onclick="toggleDcaMode()" class="card text-center px-2 cursor-pointer transition-all duration-300 hover:bg-slate-800 hover:shadow-[0_0_15px_rgba(168,85,247,0.5)] border border-transparent hover:border-purple-500 relative group select-none">
                    <div class="absolute top-1 right-1 text-slate-600 group-hover:text-purple-400 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                    </div>
                    <div class="stat-label group-hover:text-purple-200 transition-colors" id="dcaLabel">DCA Value (Daily)</div>
                    <div class="stat-value text-purple-400 text-xl transition-transform duration-200 group-active:scale-95" id="resDca">$0.00</div>
                    <div class="text-[10px] text-slate-500 mt-1" id="dcaDetails">N/A</div>
                </div>
                
                <!-- Interactive Comparison Card -->
                <div onclick="toggleComparison()" class="card text-center px-2 cursor-pointer transition-all duration-300 hover:bg-slate-800 hover:shadow-[0_0_15px_rgba(59,130,246,0.5)] border border-transparent hover:border-blue-500 relative group select-none">
                    <div class="absolute top-1 right-1 text-slate-600 group-hover:text-blue-400 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                    </div>
                    <div class="stat-label group-hover:text-blue-200 transition-colors" id="diffLabel">LP vs HODL</div>
                    <div class="stat-value text-xl transition-transform duration-200 group-active:scale-95" id="resDiff">$0.00</div>
                    <div class="text-[10px] text-slate-500 mt-1 group-hover:text-slate-400">Click to switch</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="card flex-grow">
                <canvas id="strategyChart"></canvas>
            </div>
            
            <div class="card">
                <h3 class="font-bold mb-2">Rebalance Log</h3>
                <div class="overflow-y-auto max-h-48 text-sm text-slate-300">
                    <table class="w-full text-left">
                        <thead class="text-slate-500 border-b border-slate-700">
                            <tr>
                                <th class="pb-2">Date</th>
                                <th class="pb-2">Action</th>
                                <th class="pb-2">Price</th>
                                <th class="pb-2">Reason</th>
                            </tr>
                        </thead>
                        <tbody id="logBody">
                            <!-- Logs go here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

<script>
    // --- Constants & Globals ---
    let chartInstance = null;
    let globalHistory = [];
    let currentTokenSymbol = "ETH"; // Default
    
    // Global state for results
    let finalResults = {
        lp: 0,
        hodl50: 0,
        hodl100: 0,
        dcaDaily: 0,
        dcaWeekly: 0,
        dcaMonthly: 0,
        dcaDailyLabel: '',
        dcaWeeklyLabel: '',
        dcaMonthlyLabel: ''
    };
    
    let comparisonMode = 0; // 0: Hodl50, 1: Hodl100, 2: DCA
    let dcaMode = 0; // 0: Daily, 1: Weekly, 2: Monthly

    // Set default dates
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 90);
    
    document.getElementById('endDate').valueAsDate = today;
    document.getElementById('startDate').valueAsDate = thirtyDaysAgo;

    // Helper to calculate V3 amounts
    function calculateV3Composition(P, Pa, Pb) {
        const sqrtP = Math.sqrt(P);
        const sqrtPa = Math.sqrt(Pa);
        const sqrtPb = Math.sqrt(Pb);

        if (P <= Pa) return { ethWeight: 1.0, usdcWeight: 0.0 };
        if (P >= Pb) return { ethWeight: 0.0, usdcWeight: 1.0 };
        
        const valEth = P * (1/sqrtP - 1/sqrtPb);
        const valUsdc = (sqrtP - sqrtPa);
        
        const totalVal = valEth + valUsdc;
        return { ethWeight: valEth/totalVal, usdcWeight: valUsdc/totalVal };
    }

    function toggleDcaMode() {
        dcaMode = (dcaMode + 1) % 3;
        updateDcaDisplay();
        updateComparisonDisplay();
        
        // Update Chart Data
        if (chartInstance && globalHistory.length > 0) {
            let newData = [];
            if (dcaMode === 0) newData = globalHistory.map(h => h.dcaDailyVal);
            else if (dcaMode === 1) newData = globalHistory.map(h => h.dcaWeeklyVal);
            else newData = globalHistory.map(h => h.dcaMonthlyVal);
            
            chartInstance.data.datasets[1].data = newData;
            chartInstance.update();
        }
    }

    function updateDcaDisplay() {
        const labelEl = document.getElementById('dcaLabel');
        const valEl = document.getElementById('resDca');
        const detEl = document.getElementById('dcaDetails');
        
        if (dcaMode === 0) {
            labelEl.innerText = "DCA Value (Daily)";
            valEl.innerText = `$${finalResults.dcaDaily.toFixed(2)}`;
            detEl.innerText = finalResults.dcaDailyLabel;
        } else if (dcaMode === 1) {
            labelEl.innerText = "DCA Value (Weekly)";
            valEl.innerText = `$${finalResults.dcaWeekly.toFixed(2)}`;
            detEl.innerText = finalResults.dcaWeeklyLabel;
        } else {
            labelEl.innerText = "DCA Value (Monthly)";
            valEl.innerText = `$${finalResults.dcaMonthly.toFixed(2)}`;
            detEl.innerText = finalResults.dcaMonthlyLabel;
        }
    }

    function toggleComparison() {
        comparisonMode = (comparisonMode + 1) % 3;
        updateComparisonDisplay();
    }

    function updateComparisonDisplay() {
        const labelEl = document.getElementById('diffLabel');
        const valEl = document.getElementById('resDiff');
        
        let compareVal = 0;
        let labelText = "";
        
        if (comparisonMode === 0) {
            compareVal = finalResults.hodl50;
            labelText = "LP vs HODL (50/50)";
        } else if (comparisonMode === 1) {
            compareVal = finalResults.hodl100;
            labelText = `LP vs HODL (100% ${currentTokenSymbol})`;
        } else {
            // Use currently selected DCA mode
            if (dcaMode === 0) compareVal = finalResults.dcaDaily;
            else if (dcaMode === 1) compareVal = finalResults.dcaWeekly;
            else compareVal = finalResults.dcaMonthly;
            
            labelText = "LP vs DCA";
        }
        
        const diff = finalResults.lp - compareVal;
        
        labelEl.innerText = labelText;
        valEl.innerText = `${diff >= 0 ? '+' : ''}$${diff.toFixed(2)}`;
        valEl.className = `stat-value text-xl transition-transform duration-200 group-active:scale-95 ${diff >= 0 ? 'text-green-400' : 'text-red-400'}`;
    }

    async function fetchBinanceData(symbol, interval, startTime, endTime) {
        const limit = 1000;
        let allData = [];
        let currentStart = startTime;

        while (true) {
            const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}&startTime=${currentStart}&endTime=${endTime}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (!Array.isArray(data) || data.length === 0) break;

                allData = allData.concat(data);
                
                const lastTime = data[data.length - 1][0];
                currentStart = lastTime + 1;

                if (currentStart > endTime) break;
                if (data.length < limit) break;

            } catch (e) {
                console.error("Error fetching data:", e);
                throw new Error("Failed to fetch data from Binance.");
            }
        }
        return allData;
    }

    // Helper to init DCA state objects
    function initDcaState(capital, type, startDate, endDate) {
        let interval = 86400000; // Daily
        if (type === 'weekly') interval = 604800000;
        if (type === 'monthly') interval = 2592000000;
        
        const totalDuration = endDate - startDate;
        const buys = Math.max(1, Math.floor(totalDuration / interval));
        const perBuy = capital / buys;
        
        return {
            cash: capital,
            eth: 0,
            lastTime: startDate - interval, // allow immediate buy
            interval: interval,
            perBuy: perBuy,
            buys: buys,
            label: `${buys} buys of $${perBuy.toFixed(0)}`
        };
    }
    
    // Helper to process DCA tick
    function updateDcaTick(state, time, price) {
        if (state.cash > 0.01) {
            if (time >= state.lastTime + state.interval) {
                const amountToBuy = Math.min(state.cash, state.perBuy);
                state.eth += amountToBuy / price;
                state.cash -= amountToBuy;
                state.lastTime = time;
            }
        }
        return (state.eth * price) + state.cash;
    }

    async function runBacktest() {
        const btn = document.getElementById('runBtn');
        const status = document.getElementById('statusMsg');
        const logTable = document.getElementById('logBody');
        
        logTable.innerHTML = "";
        btn.disabled = true;
        btn.innerText = "Loading Data...";
        status.innerText = "";

        try {
            // 1. Get Inputs
            const capital = parseFloat(document.getElementById('initialCapital').value);
            document.getElementById('resInitial').innerText = capital;

            const token = document.getElementById('tokenSelect').value;
            currentTokenSymbol = token; // Update global
            
            // Build Pair: Use USDC pairs. Fallback/Note: If Binance doesn't have USDC pair for ancient data, might need USDT.
            // But user asked for USDC context. Most majors have USDC pairs now.
            const symbol = token + "USDC"; 

            // Update UI Labels immediately
            const displayToken = token;
            document.getElementById('resHodl100Label').innerText = `HODL (100% ${displayToken})`;

            const rangePct = parseFloat(document.getElementById('rangePct').value) / 100;
            const rebalanceThreshold = parseFloat(document.getElementById('rebalanceThreshold').value) / 100;
            const aprAnnual = parseFloat(document.getElementById('fixedApr').value) / 100;
            const interval = document.getElementById('candleInterval').value;
            
            const startStr = document.getElementById('startDate').value;
            const endStr = document.getElementById('endDate').value;
            const startDate = new Date(startStr).getTime();
            const endDate = new Date(endStr).getTime();

            if(startDate >= endDate) {
                throw new Error("Start date must be before end date.");
            }

            // 2. Fetch Data
            const rawData = await fetchBinanceData(symbol, interval, startDate, endDate);
            if(rawData.length === 0) throw new Error(`No data found for ${symbol} in this range.`);

            const candles = rawData.map(d => ({
                time: d[0],
                open: parseFloat(d[1]),
                high: parseFloat(d[2]),
                low: parseFloat(d[3]),
                close: parseFloat(d[4])
            }));

            // 3. Initialize Strategies
            
            // --- LP Strategy State ---
            let currentCapital = capital;
            let feesCollected = 0;
            let entryPrice = candles[0].open;
            let rangeLow = entryPrice * (1 - rangePct);
            let rangeHigh = entryPrice * (1 + rangePct);
            let lastRebalancePrice = entryPrice;
            
            let currentEthAmount = 0;
            let currentUsdcAmount = 0;

            function openPosition(price, amountUSD) {
                const Pa = price * (1 - rangePct);
                const Pb = price * (1 + rangePct);
                const { ethWeight, usdcWeight } = calculateV3Composition(price, Pa, Pb);
                currentEthAmount = (amountUSD * ethWeight) / price;
                currentUsdcAmount = amountUSD * usdcWeight;
                rangeLow = Pa;
                rangeHigh = Pb;
                lastRebalancePrice = price;
            }
            openPosition(entryPrice, currentCapital);

            // --- HODL State ---
            let hodlEth = (capital * 0.5) / entryPrice;
            let hodlUsdc = capital * 0.5;
            let hodl100EthAmount = capital / entryPrice;

            // --- DCA Strategy States (Calculate all 3) ---
            let dcaDaily = initDcaState(capital, 'daily', startDate, endDate);
            let dcaWeekly = initDcaState(capital, 'weekly', startDate, endDate);
            let dcaMonthly = initDcaState(capital, 'monthly', startDate, endDate);

            const history = [];
            const rebalanceEvents = [];

            // 4. Iterate Candles
            for (let i = 0; i < candles.length; i++) {
                const c = candles[i];
                const price = c.close;

                // LP LOGIC
                const sqrtP_entry = Math.sqrt(lastRebalancePrice);
                const sqrtPa = Math.sqrt(rangeLow);
                const sqrtPb = Math.sqrt(rangeHigh);
                
                let L = 0;
                if (currentUsdcAmount > 0) L = currentUsdcAmount / (sqrtP_entry - sqrtPa);
                else L = currentEthAmount / (1/sqrtP_entry - 1/sqrtPb);

                const P_new = price;
                const sqrtP_new = Math.sqrt(P_new);
                let valEth = 0;
                let valUsdc = 0;

                if (P_new <= rangeLow) {
                    valEth = (L * (1/sqrtPa - 1/sqrtPb)) * P_new;
                } else if (P_new >= rangeHigh) {
                    valUsdc = L * (sqrtPb - sqrtPa);
                } else {
                    valEth = (L * (1/sqrtP_new - 1/sqrtPb)) * P_new;
                    valUsdc = L * (sqrtP_new - sqrtPa);
                }
                currentCapital = valEth + valUsdc;

                // Fees
                let periodsPerDay = 1;
                if (interval === '5m') periodsPerDay = 288; // 12 * 24
                if (interval === '1h') periodsPerDay = 24;
                if (interval === '6h') periodsPerDay = 4;
                if (interval === '1d') periodsPerDay = 1;
                const periodFee = currentCapital * (aprAnnual / (365 * periodsPerDay));
                feesCollected += periodFee;

                // Rebalance
                const priceChangePct = (price - lastRebalancePrice) / lastRebalancePrice;
                const hitLower = priceChangePct <= -rebalanceThreshold;
                const hitUpper = priceChangePct >= rebalanceThreshold;

                if (hitLower || hitUpper) {
                    currentCapital += periodFee; 
                    feesCollected -= periodFee;
                    openPosition(price, currentCapital);
                    
                    rebalanceEvents.push({ index: i, price: price, type: hitLower ? "Lower" : "Upper" });
                    logTable.innerHTML += `<tr>
                        <td class="text-slate-400 py-1">${new Date(c.time).toLocaleDateString()}</td>
                        <td class="text-yellow-400 font-bold">Rebalance</td>
                        <td>$${price.toFixed(2)}</td>
                        <td class="text-xs text-slate-400">${(priceChangePct*100).toFixed(2)}% move</td>
                    </tr>`;
                }

                // Update all DCA types
                const dcaDailyVal = updateDcaTick(dcaDaily, c.time, price);
                const dcaWeeklyVal = updateDcaTick(dcaWeekly, c.time, price);
                const dcaMonthlyVal = updateDcaTick(dcaMonthly, c.time, price);

                // HODL
                const currentHodlVal = (hodlEth * price) + hodlUsdc;
                const currentHodl100Val = hodl100EthAmount * price;

                history.push({
                    date: new Date(c.time).toLocaleString(),
                    lpValue: currentCapital + feesCollected,
                    hodlValue: currentHodlVal,
                    hodl100Value: currentHodl100Val,
                    dcaDailyVal: dcaDailyVal,
                    dcaWeeklyVal: dcaWeeklyVal,
                    dcaMonthlyVal: dcaMonthlyVal,
                    price: price,
                    fees: feesCollected
                });
            }

            // 5. Store Results
            globalHistory = history; // Save for chart toggling
            
            const finalVal = currentCapital + feesCollected;
            const finalHodl = (hodlEth * candles[candles.length-1].close) + hodlUsdc;
            const finalHodl100 = hodl100EthAmount * candles[candles.length-1].close;
            
            finalResults = {
                lp: finalVal,
                hodl50: finalHodl,
                hodl100: finalHodl100,
                dcaDaily: history[history.length-1].dcaDailyVal,
                dcaWeekly: history[history.length-1].dcaWeeklyVal,
                dcaMonthly: history[history.length-1].dcaMonthlyVal,
                dcaDailyLabel: dcaDaily.label,
                dcaWeeklyLabel: dcaWeekly.label,
                dcaMonthlyLabel: dcaMonthly.label
            };

            document.getElementById('resFees').innerText = `$${feesCollected.toFixed(2)}`;
            document.getElementById('resPortfolio').innerText = `$${finalVal.toFixed(2)}`;
            document.getElementById('resHodl').innerText = `$${finalHodl.toFixed(2)}`;
            document.getElementById('resHodl100').innerText = `$${finalHodl100.toFixed(2)}`;
            
            // Initial Display updates
            updateDcaDisplay();
            updateComparisonDisplay();

            renderChart(history, rebalanceEvents);

        } catch (err) {
            status.innerText = err.message;
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.innerText = "Run Backtest";
            
            // Show download button if successful
            if (!status.innerText) {
                document.getElementById('dlBtn').classList.remove('hidden');
            }
        }
    }

    async function downloadReport() {
        if (!chartInstance) return;
        
        const btn = document.getElementById('dlBtn');
        const originalText = btn.innerText;
        btn.innerText = "Generating...";
        btn.disabled = true;

        try {
            const width = 1200;
            const height = 1800;
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

            // 1. Background
            ctx.fillStyle = '#0f172a'; // Slate-900 background
            ctx.fillRect(0, 0, width, height);

            // 2. Header
            ctx.font = 'bold 48px sans-serif';
            ctx.fillStyle = '#f8fafc'; // Slate-50
            ctx.textAlign = 'center';
            ctx.fillText('LP Strategy Backtest Report', width / 2, 80);
            
            // Removed Generated Date line
            
            // 3. Settings Box
            const boxX = 50;
            const boxY = 160;
            const boxW = width - 100;
            const boxH = 300; // Increased height to fit extra line
            
            ctx.fillStyle = '#1e293b'; // Slate-800
            ctx.strokeStyle = '#334155'; // Slate-700
            ctx.lineWidth = 2;
            ctx.beginPath();
            // Round rect simulation
            ctx.moveTo(boxX + 20, boxY);
            ctx.lineTo(boxX + boxW - 20, boxY);
            ctx.quadraticCurveTo(boxX + boxW, boxY, boxX + boxW, boxY + 20);
            ctx.lineTo(boxX + boxW, boxY + boxH - 20);
            ctx.quadraticCurveTo(boxX + boxW, boxY + boxH, boxX + boxW - 20, boxY + boxH);
            ctx.lineTo(boxX + 20, boxY + boxH);
            ctx.quadraticCurveTo(boxX, boxY + boxH, boxX, boxY + boxH - 20);
            ctx.lineTo(boxX, boxY + 20);
            ctx.quadraticCurveTo(boxX, boxY, boxX + 20, boxY);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // Draw Settings Text
            ctx.textAlign = 'left';
            ctx.font = 'bold 32px sans-serif';
            ctx.fillStyle = '#e2e8f0';
            ctx.fillText('Configuration', boxX + 40, boxY + 50);

            ctx.font = '28px sans-serif';
            ctx.fillStyle = '#cbd5e1';
            
            // Col 1
            let y = boxY + 110;
            const col1X = boxX + 40;
            const col2X = boxX + 550;
            
            const tokenVal = document.getElementById('tokenSelect').value;
            const token = tokenVal === 'FTM' ? 'S' : tokenVal;
            const cap = document.getElementById('initialCapital').value;
            const range = document.getElementById('rangePct').value;
            const thresh = document.getElementById('rebalanceThreshold').value;
            const apr = document.getElementById('fixedApr').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const interval = document.getElementById('candleInterval').value;

            // Format Dates & Duration
            const sDate = new Date(start);
            const eDate = new Date(end);
            const dateOpts = { year: 'numeric', month: 'short', day: 'numeric' };
            const startTxt = sDate.toLocaleDateString('en-US', dateOpts);
            const endTxt = eDate.toLocaleDateString('en-US', dateOpts);
            
            const diffTime = Math.abs(eDate - sDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            let durationTxt = `${diffDays} days`;
            if (diffDays > 60) {
                durationTxt += ` (~${(diffDays / 30.44).toFixed(1)} months)`;
            }

            ctx.fillText(`Token: ${token}`, col1X, y); 
            ctx.fillText(`Initial Capital: $${cap}`, col1X, y + 50); 
            ctx.fillText(`APR Estimate: ${apr}%`, col1X, y + 100);

            ctx.fillText(`Range: Â±${range}%`, col2X, y); 
            ctx.fillText(`Rebalance Threshold: Â±${thresh}%`, col2X, y + 50); 
            
            // Split Period and Duration into two lines
            ctx.fillText(`Period: ${startTxt} - ${endTxt}`, col2X, y + 100);
            ctx.fillText(`(${durationTxt})`, col2X, y + 145);

            // 4. Results Box
            const resY = boxY + boxH + 40;
            const resH = 320;
            
            ctx.fillStyle = '#1e293b';
            ctx.beginPath();
            ctx.moveTo(boxX + 20, resY);
            ctx.lineTo(boxX + boxW - 20, resY);
            ctx.quadraticCurveTo(boxX + boxW, resY, boxX + boxW, resY + 20);
            ctx.lineTo(boxX + boxW, resY + resH - 20);
            ctx.quadraticCurveTo(boxX + boxW, resY + resH, boxX + boxW - 20, resY + resH);
            ctx.lineTo(boxX + 20, resY + resH);
            ctx.quadraticCurveTo(boxX, resY + resH, boxX, resY + resH - 20);
            ctx.lineTo(boxX, resY + 20);
            ctx.quadraticCurveTo(boxX, resY, boxX + 20, resY);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            ctx.font = 'bold 32px sans-serif';
            ctx.fillStyle = '#e2e8f0';
            ctx.fillText('Performance Results', boxX + 40, resY + 50);

            // Result Columns
            const fees = document.getElementById('resFees').innerText;
            const pf = document.getElementById('resPortfolio').innerText;
            const h50 = document.getElementById('resHodl').innerText;
            const h100 = document.getElementById('resHodl100').innerText;
            const dca = document.getElementById('resDca').innerText;
            
            // Grid layout for stats
            ctx.font = '24px sans-serif';
            
            // Row 1
            const r1y = resY + 120;
            const r2y = resY + 230;
            const c1 = boxX + 50, c2 = boxX + 420, c3 = boxX + 790;

            // Fees
            ctx.fillStyle = '#94a3b8'; ctx.fillText('Total Fees Earned', c1, r1y);
            ctx.fillStyle = '#4ade80'; ctx.font = 'bold 40px sans-serif'; ctx.fillText(fees, c1, r1y + 50);

            // Portfolio
            ctx.font = '24px sans-serif'; ctx.fillStyle = '#94a3b8'; ctx.fillText('Final LP Value', c2, r1y);
            ctx.fillStyle = '#e2e8f0'; ctx.font = 'bold 40px sans-serif'; ctx.fillText(pf, c2, r1y + 50);

            // DCA
            let dcaTxt = "DCA";
            if(dcaMode === 0) dcaTxt += " (Daily)";
            else if(dcaMode === 1) dcaTxt += " (Weekly)";
            else dcaTxt += " (Monthly)";

            ctx.font = '24px sans-serif'; ctx.fillStyle = '#94a3b8'; ctx.fillText(dcaTxt, c3, r1y);
            ctx.fillStyle = '#a855f7'; ctx.font = 'bold 40px sans-serif'; ctx.fillText(dca, c3, r1y + 50);

            // Row 2
            // HODL 50
            ctx.font = '24px sans-serif'; ctx.fillStyle = '#94a3b8'; ctx.fillText('HODL (50/50)', c1, r2y);
            ctx.fillStyle = '#60a5fa'; ctx.font = 'bold 40px sans-serif'; ctx.fillText(h50, c1, r2y + 50);

            // HODL 100
            ctx.font = '24px sans-serif'; ctx.fillStyle = '#94a3b8'; ctx.fillText(`HODL (100% ${token})`, c2, r2y);
            ctx.fillStyle = '#facc15'; ctx.font = 'bold 40px sans-serif'; ctx.fillText(h100, c2, r2y + 50);


            // 5. Chart
            // We need to wait for the chart image to load
            const chartImgData = chartInstance.toBase64Image();
            const chartImg = new Image();
            chartImg.src = chartImgData;
            
            await new Promise(r => chartImg.onload = r);
            
            const chartY = resY + resH + 40;
            const chartH = height - chartY - 120; // Leave space for footer
            const chartW = width - 100;
            
            // Draw chart box background
            ctx.fillStyle = '#1e293b';
            ctx.beginPath();
            ctx.moveTo(boxX + 20, chartY);
            ctx.lineTo(boxX + boxW - 20, chartY);
            ctx.quadraticCurveTo(boxX + boxW, chartY, boxX + boxW, chartY + 20);
            ctx.lineTo(boxX + boxW, chartY + chartH - 20);
            ctx.quadraticCurveTo(boxX + boxW, chartY + chartH, boxX + boxW - 20, chartY + chartH);
            ctx.lineTo(boxX + 20, chartY + chartH);
            ctx.quadraticCurveTo(boxX, chartY + chartH, boxX, chartY + chartH - 20);
            ctx.lineTo(boxX, chartY + 20);
            ctx.quadraticCurveTo(boxX, chartY, boxX + 20, chartY);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // Draw Chart Image
            ctx.drawImage(chartImg, boxX + 20, chartY + 20, chartW - 40, chartH - 40);

            // 6. Watermark
            ctx.textAlign = 'right';
            ctx.font = 'bold 30px sans-serif';
            ctx.fillStyle = '#64748b'; // Slate-500
            ctx.fillText('Made by lmoul', width - 50, height - 40);

            // 7. Download
            const link = document.createElement('a');
            link.download = `backtest_${token}_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();

        } catch(e) {
            console.error(e);
            alert("Error generating report");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    function renderChart(history, events) {
        const ctx = document.getElementById('strategyChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        const labels = history.map(h => h.date);
        const lpData = history.map(h => h.lpValue);
        const hodlData = history.map(h => h.hodlValue);
        const hodl100Data = history.map(h => h.hodl100Value);
        
        // Select initial DCA data based on current mode
        let dcaData = [];
        if (dcaMode === 0) dcaData = history.map(h => h.dcaDailyVal);
        else if (dcaMode === 1) dcaData = history.map(h => h.dcaWeeklyVal);
        else dcaData = history.map(h => h.dcaMonthlyVal);
        
        const displayToken = currentTokenSymbol;

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'LP Strategy',
                        data: lpData,
                        borderColor: '#4ade80',
                        backgroundColor: 'rgba(74, 222, 128, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0
                    },
                    {
                        label: 'DCA Strategy',
                        data: dcaData,
                        borderColor: '#a855f7', // Purple
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0
                    },
                    {
                        label: 'HODL (50/50)',
                        data: hodlData,
                        borderColor: '#60a5fa',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0
                    },
                    {
                        label: `HODL (100% ${displayToken})`,
                        data: hodl100Data,
                        borderColor: '#facc15',
                        borderWidth: 2,
                        borderDash: [2, 2],
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    },
                    legend: {
                        labels: { color: '#cbd5e1' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#94a3b8', maxTicksLimit: 10 },
                        grid: { color: '#334155' }
                    },
                    y: {
                        ticks: { color: '#94a3b8' },
                        grid: { color: '#334155' }
                    }
                }
            }
        });
    }

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uniswap V3 LP Strategy Backtester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Single Dark Theme (Warm Stone) */
        :root {
            --bg-color: #1c1917; /* Stone-900 */
            --text-main: #e7e5e4; /* Stone-200 */
            --text-muted: #a8a29e; /* Stone-400 */
            --card-bg: #292524; /* Stone-800 */
            --card-border: #44403c; /* Stone-700 */
            --input-bg: #1c1917;
            --input-border: #57534e; /* Stone-600 */
            --input-text: #f5f5f4;
            --btn-bg: #57534e;
            --btn-hover: #78716c;
            --scroll-track: #292524;
            --scroll-thumb: #57534e;
        }

        /* Brighten stats for dark mode */
        .text-emerald-600 { color: #34d399; } /* Emerald-400 */
        .text-blue-600 { color: #60a5fa; } /* Blue-400 */
        .text-amber-600 { color: #fbbf24; } /* Amber-400 */
        .text-purple-600 { color: #c084fc; } /* Purple-400 */

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main);
        }
        
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; }
        
        .input-field { 
            background: var(--input-bg); 
            border: 1px solid var(--input-border);
            padding: 0.5rem; 
            border-radius: 0.375rem; 
            color: var(--input-text);
            transition: border-color 0.2s;
        }
        .input-field:focus { outline: none; border-color: #a8a29e; }

        .btn { 
            background: var(--btn-bg);
            color: white;
            padding: 0.75rem; 
            border-radius: 0.375rem; 
            font-weight: bold; 
            cursor: pointer; 
            transition: 0.2s; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn:hover { background: var(--btn-hover); transform: translateY(-1px); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }

        .card { 
            background: var(--card-bg); 
            padding: 1.5rem; 
            border-radius: 0.75rem; 
            border: 1px solid var(--card-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        
        .stat-label { color: var(--text-muted); font-size: 0.875rem; font-weight: 500; }
        .stat-value { font-size: 1.5rem; font-weight: bold; }
        
        /* Scrollbar styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--scroll-track); }
        ::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #78716c; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-7xl mx-auto">

    <div class="mb-8 border-b border-stone-700 pb-4 flex justify-between items-start">
        <div>
            <h1 class="text-3xl font-bold mb-2 text-stone-100">LP Strategy Backtester</h1>
            <p class="text-stone-400">Simulate rebalancing strategies and compare Fees vs. Impermanent Loss vs. DCA.</p>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Configuration Panel -->
        <div class="card h-fit">
            <h2 class="text-xl font-bold mb-4 border-b border-stone-600 pb-2 text-stone-100">Strategy Settings</h2>
            
            <div class="flex flex-col gap-4">
                <!-- Token Selector -->
                <div class="input-group">
                    <label class="text-sm font-semibold">Select Token</label>
                    <select id="tokenSelect" class="input-field cursor-pointer">
                        <option value="ETH">ETH (Ethereum)</option>
                        <option value="BTC">BTC (Bitcoin)</option>
                        <option value="AVAX">AVAX (Avalanche)</option>
                        <option value="BNB">BNB (Binance Coin)</option>
                        <option value="S">S (Sonic)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label class="text-sm font-semibold">Initial Capital ($)</label>
                    <input type="number" id="initialCapital" value="10000" class="input-field">
                </div>

                <div class="input-group">
                    <label class="text-sm font-semibold">LP Range (+/- %)</label>
                    <small class="text-stone-400">The width of your liquidity position.</small>
                    <input type="number" id="rangePct" value="20" class="input-field">
                </div>

                <div class="input-group">
                    <label class="text-sm font-semibold">Rebalance Threshold (+/- %)</label>
                    <small class="text-stone-400">Trigger rebalance if price moves this much.</small>
                    <input type="number" id="rebalanceThreshold" value="15" class="input-field">
                </div>

                <div class="input-group">
                    <label class="text-sm font-semibold">Estimated APR (%)</label>
                    <small class="text-stone-400">Fixed APR assumption for fees.</small>
                    <input type="number" id="fixedApr" value="70" class="input-field">
                </div>

                <div class="input-group">
                    <label class="text-sm font-semibold">Candle Interval</label>
                    <select id="candleInterval" class="input-field cursor-pointer">
                        <option value="5m">5 Minutes</option>
                        <option value="1h">1 Hour</option>
                        <option value="6h" selected>6 Hours</option>
                        <option value="1d">1 Day</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-2 mt-2">
                    <div class="input-group">
                        <label class="text-sm font-semibold">Start Date</label>
                        <input type="date" id="startDate" class="input-field cursor-pointer">
                    </div>
                    <div class="input-group">
                        <label class="text-sm font-semibold">End Date</label>
                        <input type="date" id="endDate" class="input-field cursor-pointer">
                    </div>
                </div>

                <button onclick="runBacktest()" id="runBtn" class="btn text-center mt-2">
                    Run Backtest
                </button>
                
                <button onclick="downloadReport()" id="dlBtn" class="btn bg-stone-600 hover:bg-stone-700 text-center mt-2 hidden">
                    Download Report ðŸ“¸
                </button>
                
                <p id="statusMsg" class="text-sm text-center text-amber-600 font-medium min-h-[20px]"></p>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="col-span-1 md:col-span-2 flex flex-col gap-6">
            
            <!-- Summary Stats -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="card text-center px-2">
                    <div class="stat-label">Total Fees</div>
                    <div class="stat-value text-emerald-600 text-xl" id="resFees">$0.00</div>
                </div>
                <div class="card text-center px-2">
                    <div class="stat-label">LP Portfolio</div>
                    <div class="stat-value text-stone-100 text-xl" id="resPortfolio">$0.00</div>
                    <div class="text-[10px] text-stone-400">Start: $<span id="resInitial">10000</span></div>
                </div>
                <div class="card text-center px-2">
                    <div class="stat-label">HODL (50/50)</div>
                    <div class="stat-value text-blue-600 text-xl" id="resHodl">$0.00</div>
                </div>
                <div class="card text-center px-2">
                    <div class="stat-label" id="resHodl100Label">HODL (100% ETH)</div>
                    <div class="stat-value text-amber-600 text-xl" id="resHodl100">$0.00</div>
                </div>
                
                <!-- DCA Card (Interactive) -->
                <div onclick="toggleDcaMode()" class="card text-center px-2 cursor-pointer transition-all duration-300 hover:bg-stone-700 hover:border-purple-300 hover:shadow-md border border-stone-600 relative group select-none">
                    <div class="absolute top-1 right-1 text-stone-300 group-hover:text-purple-400 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                    </div>
                    <div class="stat-label group-hover:text-purple-400 transition-colors" id="dcaLabel">DCA Value (Daily)</div>
                    <div class="stat-value text-purple-600 text-xl transition-transform duration-200 group-active:scale-95" id="resDca">$0.00</div>
                    <div class="text-[10px] text-stone-400 mt-1" id="dcaDetails">N/A</div>
                </div>
                
                <!-- Interactive Comparison Card -->
                <div onclick="toggleComparison()" class="card text-center px-2 cursor-pointer transition-all duration-300 hover:bg-stone-700 hover:border-blue-300 hover:shadow-md border border-stone-600 relative group select-none">
                    <div class="absolute top-1 right-1 text-stone-300 group-hover:text-blue-400 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                    </div>
                    <div class="stat-label group-hover:text-blue-400 transition-colors" id="diffLabel">LP vs HODL</div>
                    <div class="stat-value text-xl transition-transform duration-200 group-active:scale-95" id="resDiff">$0.00</div>
                    <div class="text-[10px] text-stone-400 mt-1 group-hover:text-stone-300">Click to switch</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="card flex-grow h-[400px]">
                <canvas id="strategyChart"></canvas>
            </div>
            
            <div class="card">
                <h3 class="font-bold mb-2 text-stone-200">Rebalance Log</h3>
                <div class="overflow-y-auto max-h-48 text-sm text-stone-300">
                    <table class="w-full text-left">
                        <thead class="text-stone-400 border-b border-stone-600">
                            <tr>
                                <th class="pb-2">Date</th>
                                <th class="pb-2">Action</th>
                                <th class="pb-2">Price</th>
                                <th class="pb-2">Reason</th>
                            </tr>
                        </thead>
                        <tbody id="logBody">
                            <!-- Logs go here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- New DCA Log -->
            <div class="card">
                <h3 class="font-bold mb-2 text-stone-200" id="dcaLogTitle">DCA Buy Log (Daily)</h3>
                <div class="overflow-y-auto max-h-48 text-sm text-stone-300">
                    <table class="w-full text-left">
                        <thead class="text-stone-400 border-b border-stone-600">
                            <tr>
                                <th class="pb-2">Date</th>
                                <th class="pb-2">Bought</th>
                                <th class="pb-2">Price</th>
                                <th class="pb-2">Port. Value</th>
                                <th class="pb-2">Cash %</th>
                            </tr>
                        </thead>
                        <tbody id="dcaLogBody">
                            <!-- DCA Logs go here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

<script>
    // --- Constants & Globals ---
    let chartInstance = null;
    let globalHistory = [];
    let currentTokenSymbol = "ETH"; 
    let globalDcaLogs = { daily: [], weekly: [], monthly: [] }; // Store logs for switching
    
    // Global state
    let finalResults = {
        lp: 0,
        hodl50: 0,
        hodl100: 0,
        dcaDaily: 0,
        dcaWeekly: 0,
        dcaMonthly: 0,
        dcaDailyLabel: '',
        dcaWeeklyLabel: '',
        dcaMonthlyLabel: ''
    };
    
    let comparisonMode = 0; // 0: Hodl50, 1: Hodl100, 2: DCA
    let dcaMode = 0; // 0: Daily, 1: Weekly, 2: Monthly

    // Defaults
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 90);
    
    document.getElementById('endDate').valueAsDate = today;
    document.getElementById('startDate').valueAsDate = thirtyDaysAgo;

    // Helper: V3 Math
    function calculateV3Composition(P, Pa, Pb) {
        const sqrtP = Math.sqrt(P);
        const sqrtPa = Math.sqrt(Pa);
        const sqrtPb = Math.sqrt(Pb);

        if (P <= Pa) return { ethWeight: 1.0, usdcWeight: 0.0 };
        if (P >= Pb) return { ethWeight: 0.0, usdcWeight: 1.0 };
        
        const valEth = P * (1/sqrtP - 1/sqrtPb);
        const valUsdc = (sqrtP - sqrtPa);
        
        const totalVal = valEth + valUsdc;
        return { ethWeight: valEth/totalVal, usdcWeight: valUsdc/totalVal };
    }

    function toggleDcaMode() {
        dcaMode = (dcaMode + 1) % 3;
        updateDcaDisplay();
        updateComparisonDisplay();
        renderDcaLog(); // Update the log table
        
        // Update Chart
        if (chartInstance && globalHistory.length > 0) {
            let newData = [];
            if (dcaMode === 0) newData = globalHistory.map(h => h.dcaDailyVal);
            else if (dcaMode === 1) newData = globalHistory.map(h => h.dcaWeeklyVal);
            else newData = globalHistory.map(h => h.dcaMonthlyVal);
            
            chartInstance.data.datasets[1].data = newData;
            chartInstance.update();
        }
    }

    function updateDcaDisplay() {
        const labelEl = document.getElementById('dcaLabel');
        const titleEl = document.getElementById('dcaLogTitle'); // Update log title too
        const valEl = document.getElementById('resDca');
        const detEl = document.getElementById('dcaDetails');
        
        if (dcaMode === 0) {
            labelEl.innerText = "DCA Value (Daily)";
            titleEl.innerText = "DCA Buy Log (Daily)";
            valEl.innerText = `$${finalResults.dcaDaily.toFixed(2)}`;
            detEl.innerText = finalResults.dcaDailyLabel;
        } else if (dcaMode === 1) {
            labelEl.innerText = "DCA Value (Weekly)";
            titleEl.innerText = "DCA Buy Log (Weekly)";
            valEl.innerText = `$${finalResults.dcaWeekly.toFixed(2)}`;
            detEl.innerText = finalResults.dcaWeeklyLabel;
        } else {
            labelEl.innerText = "DCA Value (Monthly)";
            titleEl.innerText = "DCA Buy Log (Monthly)";
            valEl.innerText = `$${finalResults.dcaMonthly.toFixed(2)}`;
            detEl.innerText = finalResults.dcaMonthlyLabel;
        }
    }

    function renderDcaLog() {
        const tbody = document.getElementById('dcaLogBody');
        tbody.innerHTML = "";
        
        let logs = [];
        if (dcaMode === 0) logs = globalDcaLogs.daily;
        else if (dcaMode === 1) logs = globalDcaLogs.weekly;
        else logs = globalDcaLogs.monthly;

        // Dark Theme Colors
        const dateColor = 'text-stone-400';
        const valColor = 'text-stone-300';

        // Show last 50 entries or all? Let's show all but it scrolls
        logs.forEach(log => {
            const row = `<tr>
                <td class="${dateColor} py-1">${new Date(log.time).toLocaleDateString()}</td>
                <td class="text-purple-400 font-medium">+${log.bought.toFixed(4)} ${currentTokenSymbol}</td>
                <td class="${valColor}">$${log.price.toFixed(2)}</td>
                <td class="${valColor}">$${log.totalValue.toFixed(2)}</td>
                <td class="text-xs text-stone-500">${log.cashPct.toFixed(1)}%</td>
            </tr>`;
            tbody.innerHTML += row;
        });
        
        if(logs.length === 0) {
             tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-stone-500">No buys triggered yet.</td></tr>`;
        } else if (globalHistory.length > 0) {
            // Add Final Value Row to match the Summary Box
            // This explains the difference between the last buy value and the final portfolio value
            const lastH = globalHistory[globalHistory.length - 1];
            let finalVal = 0;
            if (dcaMode === 0) finalVal = finalResults.dcaDaily;
            else if (dcaMode === 1) finalVal = finalResults.dcaWeekly;
            else finalVal = finalResults.dcaMonthly;

            const row = `<tr class="bg-stone-700 font-bold border-t border-stone-500">
                <td class="${dateColor} py-1">Current</td>
                <td class="text-stone-400">-</td>
                <td class="${valColor}">$${lastH.price.toFixed(2)}</td>
                <td class="${valColor}">$${finalVal.toFixed(2)}</td>
                <td class="text-xs text-stone-400">-</td>
            </tr>`;
            tbody.innerHTML += row;
        }
    }

    function toggleComparison() {
        comparisonMode = (comparisonMode + 1) % 3;
        updateComparisonDisplay();
    }

    function updateComparisonDisplay() {
        const labelEl = document.getElementById('diffLabel');
        const valEl = document.getElementById('resDiff');
        
        let compareVal = 0;
        let labelText = "";
        
        if (comparisonMode === 0) {
            compareVal = finalResults.hodl50;
            labelText = "LP vs HODL (50/50)";
        } else if (comparisonMode === 1) {
            compareVal = finalResults.hodl100;
            labelText = `LP vs HODL (100% ${currentTokenSymbol})`;
        } else {
            if (dcaMode === 0) compareVal = finalResults.dcaDaily;
            else if (dcaMode === 1) compareVal = finalResults.dcaWeekly;
            else compareVal = finalResults.dcaMonthly;
            labelText = "LP vs DCA";
        }
        
        const diff = finalResults.lp - compareVal;
        
        labelEl.innerText = labelText;
        valEl.innerText = `${diff >= 0 ? '+' : ''}$${diff.toFixed(2)}`;
        
        // Dynamic class colors for JS-controlled element
        valEl.className = `stat-value text-xl transition-transform duration-200 group-active:scale-95`;
        if (diff >= 0) valEl.style.color = '#34d399'; // Emerald-400
        else valEl.style.color = '#f87171'; // Red-400
    }

    async function fetchBinanceData(symbol, interval, startTime, endTime) {
        const limit = 1000;
        let allData = [];
        let currentStart = startTime;

        while (true) {
            const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}&startTime=${currentStart}&endTime=${endTime}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (!Array.isArray(data) || data.length === 0) break;

                allData = allData.concat(data);
                
                const lastTime = data[data.length - 1][0];
                currentStart = lastTime + 1;

                if (currentStart > endTime) break;
                if (data.length < limit) break;

            } catch (e) {
                console.error("Error fetching data:", e);
                throw new Error("Failed to fetch data from Binance.");
            }
        }
        return allData;
    }

    function initDcaState(capital, type, startDate, endDate) {
        let interval = 86400000; // Daily
        if (type === 'weekly') interval = 604800000;
        if (type === 'monthly') interval = 2592000000;
        
        const totalDuration = endDate - startDate;
        const buys = Math.max(1, Math.floor(totalDuration / interval));
        const perBuy = capital / buys;
        
        return {
            cash: capital,
            eth: 0,
            lastTime: startDate - interval, 
            interval: interval,
            perBuy: perBuy,
            buys: buys,
            label: `${buys} buys of $${perBuy.toFixed(0)}`
        };
    }
    
    // Updated to accept logArray
    function updateDcaTick(state, time, price, logArray) {
        if (state.cash > 0.01) {
            if (time >= state.lastTime + state.interval) {
                const amountToBuy = Math.min(state.cash, state.perBuy);
                const tokenAmount = amountToBuy / price;
                
                state.eth += tokenAmount;
                state.cash -= amountToBuy;
                state.lastTime = time;
                
                // Log event
                const totalVal = (state.eth * price) + state.cash;
                const cashPct = (state.cash / totalVal) * 100;
                
                if (logArray) {
                    logArray.push({
                        time: time,
                        bought: tokenAmount,
                        price: price,
                        cost: amountToBuy,
                        totalValue: totalVal,
                        cashPct: cashPct
                    });
                }
            }
        }
        return (state.eth * price) + state.cash;
    }

    async function runBacktest() {
        const btn = document.getElementById('runBtn');
        const status = document.getElementById('statusMsg');
        const logTable = document.getElementById('logBody');
        const dcaTable = document.getElementById('dcaLogBody');
        
        logTable.innerHTML = "";
        dcaTable.innerHTML = ""; // Clear DCA table visually
        
        btn.disabled = true;
        btn.innerText = "Loading Data...";
        status.innerText = "";

        try {
            // Inputs
            const capital = parseFloat(document.getElementById('initialCapital').value);
            document.getElementById('resInitial').innerText = capital;

            const token = document.getElementById('tokenSelect').value;
            currentTokenSymbol = token;
            
            const symbol = token + "USDC"; 
            const displayToken = token;
            document.getElementById('resHodl100Label').innerText = `HODL (100% ${displayToken})`;

            const rangePct = parseFloat(document.getElementById('rangePct').value) / 100;
            const rebalanceThreshold = parseFloat(document.getElementById('rebalanceThreshold').value) / 100;
            const aprAnnual = parseFloat(document.getElementById('fixedApr').value) / 100;
            const interval = document.getElementById('candleInterval').value;
            
            const startStr = document.getElementById('startDate').value;
            const endStr = document.getElementById('endDate').value;
            const startDate = new Date(startStr).getTime();
            const endDate = new Date(endStr).getTime();

            if(startDate >= endDate) throw new Error("Start date must be before end date.");

            // Data
            const rawData = await fetchBinanceData(symbol, interval, startDate, endDate);
            if(rawData.length === 0) throw new Error(`No data found for ${symbol} in this range.`);

            const candles = rawData.map(d => ({
                time: d[0],
                open: parseFloat(d[1]),
                high: parseFloat(d[2]),
                low: parseFloat(d[3]),
                close: parseFloat(d[4])
            }));

            // Strategy Init
            let currentCapital = capital;
            let feesCollected = 0;
            let entryPrice = candles[0].open;
            let rangeLow = entryPrice * (1 - rangePct);
            let rangeHigh = entryPrice * (1 + rangePct);
            let lastRebalancePrice = entryPrice;
            
            let currentEthAmount = 0;
            let currentUsdcAmount = 0;

            function openPosition(price, amountUSD) {
                const Pa = price * (1 - rangePct);
                const Pb = price * (1 + rangePct);
                const { ethWeight, usdcWeight } = calculateV3Composition(price, Pa, Pb);
                currentEthAmount = (amountUSD * ethWeight) / price;
                currentUsdcAmount = amountUSD * usdcWeight;
                rangeLow = Pa;
                rangeHigh = Pb;
                lastRebalancePrice = price;
            }
            openPosition(entryPrice, currentCapital);

            let hodlEth = (capital * 0.5) / entryPrice;
            let hodlUsdc = capital * 0.5;
            let hodl100EthAmount = capital / entryPrice;

            let dcaDaily = initDcaState(capital, 'daily', startDate, endDate);
            let dcaWeekly = initDcaState(capital, 'weekly', startDate, endDate);
            let dcaMonthly = initDcaState(capital, 'monthly', startDate, endDate);
            
            // Log Arrays
            let dcaDailyLogs = [];
            let dcaWeeklyLogs = [];
            let dcaMonthlyLogs = [];

            const history = [];
            const rebalanceEvents = [];

            // Loop
            for (let i = 0; i < candles.length; i++) {
                const c = candles[i];
                const price = c.close;

                // LP Logic
                const sqrtP_entry = Math.sqrt(lastRebalancePrice);
                const sqrtPa = Math.sqrt(rangeLow);
                const sqrtPb = Math.sqrt(rangeHigh);
                
                let L = 0;
                if (currentUsdcAmount > 0) L = currentUsdcAmount / (sqrtP_entry - sqrtPa);
                else L = currentEthAmount / (1/sqrtP_entry - 1/sqrtPb);

                const P_new = price;
                const sqrtP_new = Math.sqrt(P_new);
                let valEth = 0;
                let valUsdc = 0;

                if (P_new <= rangeLow) {
                    valEth = (L * (1/sqrtPa - 1/sqrtPb)) * P_new;
                } else if (P_new >= rangeHigh) {
                    valUsdc = L * (sqrtPb - sqrtPa);
                } else {
                    valEth = (L * (1/sqrtP_new - 1/sqrtPb)) * P_new;
                    valUsdc = L * (sqrtP_new - sqrtPa);
                }
                currentCapital = valEth + valUsdc;

                // Fees
                let periodsPerDay = 1;
                if (interval === '5m') periodsPerDay = 288;
                if (interval === '1h') periodsPerDay = 24;
                if (interval === '6h') periodsPerDay = 4;
                if (interval === '1d') periodsPerDay = 1;
                const periodFee = currentCapital * (aprAnnual / (365 * periodsPerDay));
                feesCollected += periodFee;

                // Rebalance
                const priceChangePct = (price - lastRebalancePrice) / lastRebalancePrice;
                const hitLower = priceChangePct <= -rebalanceThreshold;
                const hitUpper = priceChangePct >= rebalanceThreshold;

                if (hitLower || hitUpper) {
                    currentCapital += periodFee; 
                    feesCollected -= periodFee;
                    openPosition(price, currentCapital);
                    
                    rebalanceEvents.push({ index: i, price: price, type: hitLower ? "Lower" : "Upper" });
                    logTable.innerHTML += `<tr>
                        <td class="text-stone-400 py-1">${new Date(c.time).toLocaleDateString()}</td>
                        <td class="text-amber-600 font-bold">Rebalance</td>
                        <td class="text-stone-300">$${price.toFixed(2)}</td>
                        <td class="text-xs text-stone-500">${(priceChangePct*100).toFixed(2)}% move</td>
                    </tr>`;
                }

                // Pass specific log arrays
                const dcaDailyVal = updateDcaTick(dcaDaily, c.time, price, dcaDailyLogs);
                const dcaWeeklyVal = updateDcaTick(dcaWeekly, c.time, price, dcaWeeklyLogs);
                const dcaMonthlyVal = updateDcaTick(dcaMonthly, c.time, price, dcaMonthlyLogs);

                const currentHodlVal = (hodlEth * price) + hodlUsdc;
                const currentHodl100Val = hodl100EthAmount * price;

                history.push({
                    date: new Date(c.time).toLocaleString(),
                    lpValue: currentCapital + feesCollected,
                    hodlValue: currentHodlVal,
                    hodl100Value: currentHodl100Val,
                    dcaDailyVal: dcaDailyVal,
                    dcaWeeklyVal: dcaWeeklyVal,
                    dcaMonthlyVal: dcaMonthlyVal,
                    price: price,
                    fees: feesCollected
                });
            }

            // Results
            globalHistory = history;
            globalDcaLogs = {
                daily: dcaDailyLogs,
                weekly: dcaWeeklyLogs,
                monthly: dcaMonthlyLogs
            };
            
            const finalVal = currentCapital + feesCollected;
            const finalHodl = (hodlEth * candles[candles.length-1].close) + hodlUsdc;
            const finalHodl100 = hodl100EthAmount * candles[candles.length-1].close;
            
            finalResults = {
                lp: finalVal,
                hodl50: finalHodl,
                hodl100: finalHodl100,
                dcaDaily: history[history.length-1].dcaDailyVal,
                dcaWeekly: history[history.length-1].dcaWeeklyVal,
                dcaMonthly: history[history.length-1].dcaMonthlyVal,
                dcaDailyLabel: dcaDaily.label,
                dcaWeeklyLabel: dcaWeekly.label,
                dcaMonthlyLabel: dcaMonthly.label
            };

            document.getElementById('resFees').innerText = `$${feesCollected.toFixed(2)}`;
            document.getElementById('resPortfolio').innerText = `$${finalVal.toFixed(2)}`;
            document.getElementById('resHodl').innerText = `$${finalHodl.toFixed(2)}`;
            document.getElementById('resHodl100').innerText = `$${finalHodl100.toFixed(2)}`;
            
            updateDcaDisplay(); // This handles title
            renderDcaLog();     // This handles table content
            updateComparisonDisplay();

            renderChart(history, rebalanceEvents);

        } catch (err) {
            status.innerText = err.message;
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.innerText = "Run Backtest";
            if (!status.innerText) document.getElementById('dlBtn').classList.remove('hidden');
        }
    }

    async function downloadReport() {
        if (!chartInstance) return;
        
        const btn = document.getElementById('dlBtn');
        const originalText = btn.innerText;
        btn.innerText = "Generating...";
        btn.disabled = true;

        try {
            const width = 1200;
            const height = 1800;
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

            // Dark Theme Colors (Warm Stone)
            const bgColor = '#1c1917';
            const boxColor = '#292524';
            const borderColor = '#44403c';
            const mainText = '#e7e5e4';
            const mutedText = '#a8a29e';
            const highlightText = '#f5f5f4';
            
            const emerald = '#34d399';
            const violet = '#c084fc';
            const blue = '#60a5fa';
            const amber = '#fbbf24';

            // 1. Background
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, width, height);

            // 2. Header
            ctx.font = 'bold 48px sans-serif';
            ctx.fillStyle = mainText;
            ctx.textAlign = 'center';
            ctx.fillText('LP Strategy Backtest Report', width / 2, 80);
            
            // 3. Settings Box
            const boxX = 50;
            const boxY = 160;
            const boxW = width - 100;
            const boxH = 300; 
            
            ctx.fillStyle = boxColor;
            ctx.strokeStyle = borderColor;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.roundRect(boxX, boxY, boxW, boxH, 20);
            ctx.fill();
            ctx.stroke();

            // Settings Text
            ctx.textAlign = 'left';
            ctx.font = 'bold 32px sans-serif';
            ctx.fillStyle = highlightText;
            ctx.fillText('Configuration', boxX + 40, boxY + 50);

            ctx.font = '28px sans-serif';
            ctx.fillStyle = mutedText;
            
            // Col 1
            let y = boxY + 110;
            const col1X = boxX + 40;
            const col2X = boxX + 550;
            
            const tokenVal = document.getElementById('tokenSelect').value;
            const token = tokenVal === 'FTM' ? 'S' : tokenVal;
            const cap = document.getElementById('initialCapital').value;
            const range = document.getElementById('rangePct').value;
            const thresh = document.getElementById('rebalanceThreshold').value;
            const apr = document.getElementById('fixedApr').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            // Date Format
            const sDate = new Date(start);
            const eDate = new Date(end);
            const dateOpts = { year: 'numeric', month: 'short', day: 'numeric' };
            const startTxt = sDate.toLocaleDateString('en-US', dateOpts);
            const endTxt = eDate.toLocaleDateString('en-US', dateOpts);
            
            const diffTime = Math.abs(eDate - sDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            let durationTxt = `${diffDays} days`;
            if (diffDays > 60) {
                durationTxt += ` (~${(diffDays / 30.44).toFixed(1)} months)`;
            }

            ctx.fillText(`Token: ${token}`, col1X, y); 
            ctx.fillText(`Initial Capital: $${cap}`, col1X, y + 50); 
            ctx.fillText(`APR Estimate: ${apr}%`, col1X, y + 100);

            ctx.fillText(`Range: Â±${range}%`, col2X, y); 
            ctx.fillText(`Rebalance Threshold: Â±${thresh}%`, col2X, y + 50); 
            
            ctx.fillText(`Period: ${startTxt} - ${endTxt}`, col2X, y + 100);
            ctx.fillText(`(${durationTxt})`, col2X, y + 145);

            // 4. Results Box
            const resY = boxY + boxH + 40;
            const resH = 320;
            
            ctx.fillStyle = boxColor;
            ctx.strokeStyle = borderColor;
            ctx.beginPath();
            ctx.roundRect(boxX, resY, boxW, resH, 20);
            ctx.fill();
            ctx.stroke();

            ctx.font = 'bold 32px sans-serif';
            ctx.fillStyle = highlightText;
            ctx.fillText('Performance Results', boxX + 40, resY + 50);

            // Result Columns
            const fees = document.getElementById('resFees').innerText;
            const pf = document.getElementById('resPortfolio').innerText;
            const h50 = document.getElementById('resHodl').innerText;
            const h100 = document.getElementById('resHodl100').innerText;
            const dca = document.getElementById('resDca').innerText;
            
            ctx.font = '24px sans-serif';
            
            const r1y = resY + 120;
            const r2y = resY + 230;
            const c1 = boxX + 50, c2 = boxX + 420, c3 = boxX + 790;

            // Fees
            ctx.fillStyle = mutedText; ctx.fillText('Total Fees Earned', c1, r1y);
            ctx.fillStyle = emerald; ctx.font = 'bold 40px sans-serif'; ctx.fillText(fees, c1, r1y + 50); 

            // Portfolio
            ctx.font = '24px sans-serif'; ctx.fillStyle = mutedText; ctx.fillText('Final LP Value', c2, r1y);
            ctx.fillStyle = highlightText; ctx.font = 'bold 40px sans-serif'; ctx.fillText(pf, c2, r1y + 50);

            // DCA
            let dcaTxt = "DCA";
            if(dcaMode === 0) dcaTxt += " (Daily)";
            else if(dcaMode === 1) dcaTxt += " (Weekly)";
            else dcaTxt += " (Monthly)";

            ctx.font = '24px sans-serif'; ctx.fillStyle = mutedText; ctx.fillText(dcaTxt, c3, r1y);
            ctx.fillStyle = violet; ctx.font = 'bold 40px sans-serif'; ctx.fillText(dca, c3, r1y + 50);

            // HODL 50
            ctx.font = '24px sans-serif'; ctx.fillStyle = mutedText; ctx.fillText('HODL (50/50)', c1, r2y);
            ctx.fillStyle = blue; ctx.font = 'bold 40px sans-serif'; ctx.fillText(h50, c1, r2y + 50);

            // HODL 100
            ctx.font = '24px sans-serif'; ctx.fillStyle = mutedText; ctx.fillText(`HODL (100% ${token})`, c2, r2y);
            ctx.fillStyle = amber; ctx.font = 'bold 40px sans-serif'; ctx.fillText(h100, c2, r2y + 50);


            // 5. Chart
            const chartImgData = chartInstance.toBase64Image();
            const chartImg = new Image();
            chartImg.src = chartImgData;
            
            await new Promise(r => chartImg.onload = r);
            
            const chartY = resY + resH + 40;
            const chartH = height - chartY - 120; 
            const chartW = width - 100;
            
            ctx.fillStyle = boxColor;
            ctx.strokeStyle = borderColor;
            ctx.beginPath();
            ctx.roundRect(boxX, chartY, boxW, chartH, 20);
            ctx.fill();
            ctx.stroke();

            // Draw Chart Image
            ctx.drawImage(chartImg, boxX + 20, chartY + 20, chartW - 40, chartH - 40);

            // 6. Watermark
            ctx.textAlign = 'right';
            ctx.font = 'bold 30px sans-serif';
            ctx.fillStyle = mutedText; 
            ctx.fillText('Made by lmoul', width - 50, height - 40);

            // 7. Download
            const link = document.createElement('a');
            link.download = `backtest_${token}_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();

        } catch(e) {
            console.error(e);
            alert("Error generating report");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    function renderChart(history, events) {
        const ctx = document.getElementById('strategyChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        const labels = history.map(h => h.date);
        const lpData = history.map(h => h.lpValue);
        const hodlData = history.map(h => h.hodlValue);
        const hodl100Data = history.map(h => h.hodl100Value);
        
        let dcaData = [];
        if (dcaMode === 0) dcaData = history.map(h => h.dcaDailyVal);
        else if (dcaMode === 1) dcaData = history.map(h => h.dcaWeeklyVal);
        else dcaData = history.map(h => h.dcaMonthlyVal);
        
        const displayToken = currentTokenSymbol;
        
        // Dark Theme Colors
        const gridColor = '#44403c';
        const tickColor = '#a8a29e';
        const legendColor = '#e7e5e4';

        const cLp = '#34d399';
        const cDca = '#c084fc';
        const cHodl = '#60a5fa';
        const cHodl100 = '#fbbf24';

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'LP Strategy',
                        data: lpData,
                        borderColor: cLp, 
                        backgroundColor: 'rgba(52, 211, 153, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0
                    },
                    {
                        label: 'DCA Strategy',
                        data: dcaData,
                        borderColor: cDca,
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0
                    },
                    {
                        label: 'HODL (50/50)',
                        data: hodlData,
                        borderColor: cHodl,
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0
                    },
                    {
                        label: `HODL (100% ${displayToken})`,
                        data: hodl100Data,
                        borderColor: cHodl100,
                        borderWidth: 2,
                        borderDash: [2, 2],
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    tooltip: {
                        backgroundColor: '#292524',
                        titleColor: '#e7e5e4',
                        bodyColor: '#a8a29e',
                        borderColor: '#44403c',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    },
                    legend: {
                        labels: { color: legendColor } 
                    }
                },
                scales: {
                    x: {
                        ticks: { color: tickColor, maxTicksLimit: 10 },
                        grid: { color: gridColor } 
                    },
                    y: {
                        ticks: { color: tickColor },
                        grid: { color: gridColor } 
                    }
                }
            }
        });
    }

</script>
</body>
</html>
